<!DOCTYPE html>
<html lang="en">
<html>
<head>
	<meta charset="utf-8">
	<title>Live Game Report</title>
	<script src="../d3.v4.min.js"></script>
</head>
<body>
	<p id="message"></p>
</body>
<script>

var pbpUrl = "http://www.nhl.com/scores/htmlreports/20162017/PL020188.HTM";
var dataset = [];

d3.html(pbpUrl, function(error, html) {
	if (error) {
		d3.select("#message").text("Error getting data.");
		console.log("Error getting data: " + error);
	} else {
		console.log(html);
		var trs = html.querySelectorAll("tr.evenColor");
		trs.forEach(function(tr) {

			// Parse data in each of the event row's cells
			var tds = tr.querySelectorAll("td.bborder");

			var playId = parseInt(tds[0].innerHTML);
			var period = parseInt(tds[1].innerHTML);

			var strength = tds[2].innerHTML;
			if (strength === "&nbsp;") {
				strength = null;
			}

			var timeString = tds[3].innerHTML;
			timeString = timeString.substring(0, timeString.indexOf("<br>"));
			var mm = parseInt(timeString.substring(0, timeString.indexOf(":")));
			var ss = parseInt(timeString.substring(timeString.indexOf(":") + 1));
			var time = 60 * mm + ss;

			var event = tds[4].innerHTML;
			var description = tds[5].innerHTML;

			// Away and home player information is stored in font elements
			var aOnIce = [];
			tds[6].querySelectorAll("font").forEach(function(font) {
				aOnIce.push(parsePlayerInformation(font));
			});

			var hOnIce = [];
			tds[7].querySelectorAll("font").forEach(function(font) {
				hOnIce.push(parsePlayerInformation(font));
			});

			// Store parsed data
			dataset.push({
				playId: playId,
				period: period,
				strength: strength,
				time: time,
				event: event,
				description: description,
				aOnIce: aOnIce,
				hOnIce: hOnIce
			});
		});
		console.log(dataset);
	}
});

//
//
// Player information is stored in font elements
// This function parses the information stored in the font element
//
//

function parsePlayerInformation(fontElement) {
	var jersey = fontElement.innerHTML;
	var name = fontElement.title.substring(fontElement.title.indexOf(" - ") + 3);
	var position = fontElement.title.substring(0, fontElement.title.indexOf(" - "));	
	return {
		jersey: jersey,
		name: name,
		position: position
	};
}
</script>
</html>