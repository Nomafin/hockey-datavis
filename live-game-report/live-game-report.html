<!DOCTYPE html>
<html lang="en">
<html>
<head>
	<meta charset="utf-8">
	<title>Live Game Report</title>
	<link rel="stylesheet" type="text/css" href="live-game-report.css">
	<script src="../d3.v4.min.js"></script>
</head>
<body>
	<button onclick="fetchData();">Refresh</button>
	<p id="message"></p>
	<table class="player-stats" style="width: 100%;">
		<thead>
			<th colspan=2 width="37%">AWAY</th>
			<th width="9%">G</th>
			<th width="9%">A</th>
			<th width="9%">GF</th>
			<th width="9%">GA</th>
			<th width="9%">CF</th>
			<th width="9%">CA</th>
			<th width="9%">TOI</th>
		</thead>
		<tbody>
		</tbody>
	</table>
	<table class="player-stats" style="width: 100%;">
		<thead>
			<th colspan=2 width="37%">HOME</th>
			<th width="9%">G</th>
			<th width="9%">A</th>
			<th width="9%">GF</th>
			<th width="9%">GA</th>
			<th width="9%">CF</th>
			<th width="9%">CA</th>
			<th width="9%">TOI</th>
		</thead>
		<tbody>
		</tbody>
	</table>	
</body>
<script>

var pbpUrl = "http://www.nhl.com/scores/htmlreports/20162017/PL020204.HTM";
var eventData = [];
var playerData = [[], []];
var teamData = [];

function fetchData() {

	// Reset data
	eventData = [];
	playerData = [[], []];
	teamData = [];

	d3.html(pbpUrl, function(error, html) {
		if (error) {
			d3.select("#message").text("Error getting data.");
			console.log("Error getting data: " + error);
		} else {

			//
			// Parse and store team data
			//

			teamData.push(initializeTeamInformation(html.querySelector("#Visitor"), "away"));
			teamData.push(initializeTeamInformation(html.querySelector("#Home"), "home"));

			//
			// Parse and store event data
			//

			var trs = html.querySelectorAll("tr.evenColor");
			trs.forEach(function(tr) {

				// Parse data in each of the event row's cells
				var tds = tr.querySelectorAll("td.bborder");

				var playId = parseInt(tds[0].innerHTML);
				var period = parseInt(tds[1].innerHTML);

				var timeString = tds[3].innerHTML;
				timeString = timeString.substring(0, timeString.indexOf("<br>"));
				var mm = parseInt(timeString.substring(0, timeString.indexOf(":")));
				var ss = parseInt(timeString.substring(timeString.indexOf(":") + 1));
				var time = 60 * mm + ss;

				var event = tds[4].innerHTML.toLowerCase();
				var description = tds[5].innerHTML;

				var strength = tds[2].innerHTML.toLowerCase();
				if (strength === "&nbsp;") {
					strength = null;
				} else if (event === "block") {
					// For blocked shots, the strength is officially recorded from the blocker's POV
					// Flip this so it's from the shooter's POV
					if (strength === "pp") {
						strength = "sh";
					} else if (strength === "sh") {
						strength = "pp";
					}
				}

				// Get the team and players responsible for the event
				var team = getEventTeam(event, description);
				var venue = null;
				if (team != null) {
					venue = teamData.find(function(d) { return d.abbreviation === team; }).venue;
				}

				// Away and home player information is stored in font elements
				var aOnIce = [];
				tds[6].querySelectorAll("font").forEach(function(font) {
					aOnIce.push(parseInt(font.innerHTML));
					initializePlayerData(font, "away");
				});

				var hOnIce = [];
				tds[7].querySelectorAll("font").forEach(function(font) {
					hOnIce.push(parseInt(font.innerHTML));
					initializePlayerData(font, "home");
				});

				// Store parsed data
				eventData.push({
					playId: playId,
					period: period,
					strength: strength,
					time: time,
					event: event,
					description: description,
					team: team,
					venue: venue,
					aOnIce: aOnIce,
					hOnIce: hOnIce
				});
			});
			
			calculateTeamAndPlayerStats();
		}
	});
}

function incrementPlayerStat(venue, jersey, stat) {
	var teamIdx = 0;
	if (venue === "home") {
		teamIdx = 1;
	}
	var player = playerData[teamIdx].find(function(d) { return d.jersey === jersey; });
	player[stat]++;
	return;
}

function calculateTeamAndPlayerStats() {

	eventData.forEach(function(ev, i) {

		//
		// Increment counts for individual stats: goals scored, assists, individual corsi, penalties
		//

		if (ev.event === "goal") {
			// Increment goals and corsis for scorer
			var string = ev.description.substring(ev.description.indexOf("#") + 1, ev.description.indexOf(", "));
			var jersey = parseInt(string.substring(0, string.indexOf(" ")));
			incrementPlayerStat(ev.venue, jersey, ev.strength + "_ig");
			incrementPlayerStat(ev.venue, jersey, ev.strength + "_ic");

			// Increment assists
			var string = ev.description.substring(ev.description.indexOf("Assist"));
			var strings = string.split("; ");
			strings.forEach(function(s) {
				var jerseyString = s.substring(s.indexOf("#") + 1);
				var jersey = parseInt(jerseyString.substring(0, jerseyString.indexOf(" ")));
				incrementPlayerStat(ev.venue, jersey, ev.strength + "_ia");
			});
		} else if (ev.event === "shot" || ev.event === "block" || ev.event === "miss") {
			// Increment corsis for shooter
			var string = ev.description.substring(ev.description.indexOf("#") + 1);
			var jersey = parseInt(string.substring(0, string.indexOf(" ")));
			incrementPlayerStat(ev.venue, jersey, ev.strength + "_ic");
		}

		//
		// Increment counts for on-ice events: corsis, shots, goals
		//

		if (ev.event === "goal" || ev.event === "shot" || ev.event === "block" || ev.event === "miss") {

			// Increment AWAY players' stats
			var strength = ev.strength;
			var statSuffix = "f";
			if (ev.venue === "home") {
				// If the home team took the shot, then flip the strength and stat
				statSuffix = "a";
				if (ev.strength === "pp") {
					strength = "sh";
				} else if (ev.strength === "sh") {
					strength = "pp";
				}
			}
			ev.aOnIce.forEach(function(playerJersey) {
				incrementPlayerStat("away", playerJersey, strength + "_c" + statSuffix);
				if (ev.event === "goal") {
					incrementPlayerStat("away", playerJersey, strength + "_g" + statSuffix);
					incrementPlayerStat("away", playerJersey, strength + "_s" + statSuffix);
				} else if (ev.event === "shot") {
					incrementPlayerStat("away", playerJersey, strength + "_s" + statSuffix);
				}
			});

			// Increment HOME players' stats
			var strength = ev.strength;
			var statSuffix = "f";
			if (ev.venue === "away") {
				// If the away team took the shot, then flip the strength and stat
				statSuffix = "a";
				if (ev.strength === "pp") {
					strength = "sh";
				} else if (ev.strength === "sh") {
					strength = "pp";
				}
			}
			ev.hOnIce.forEach(function(playerJersey) {
				incrementPlayerStat("home", playerJersey, strength + "_c" + statSuffix);
				if (ev.event === "goal") {
					incrementPlayerStat("home", playerJersey, strength + "_g" + statSuffix);
					incrementPlayerStat("home", playerJersey, strength + "_s" + statSuffix);
				} else if (ev.event === "shot") {
					incrementPlayerStat("home", playerJersey, strength + "_s" + statSuffix);
				}
			});
		}
	});

	// Calculate shifts and calculate tois
	// forEach event:
	//
	//		if thisEvent.aOnIce > thisEvent.hOnIce:
	//			aTeamToiPp += nextEventTime - thisEventTime;
	//			hTeamToiSh += nextEventTime - thisEventTime;
	//			aTeamPpTimeRanges.push([thisEventTime, nextEventTime]);
	// 		else if thisEvent.aOnIce < thisEvent.hOnIce:
	//			hTeamToiPp += nextEventTime - thisEventTime;
	//			aTeamToiSh += nextEventTime - thisEventTime;
	//			hTeamPpTimeRanges.push([thisEventTime, nextEventTime]);
	//
	//		forEach player in event:
	//			thisPlayerToi += nextEventTime - thisEventTime;
	//			
	//			if thisEvent.aOnIce > thisEvent.hOnIce:
	//				thisPlayerToiSh += nextEventTime - thisEventTime;
	// 			else if thisEvent.aOnIce < thisEvent.hOnIce:
	//				thisPlayerToiPp += nextEventTime - thisEventTime;

	// Clean up aTeamPpTimeRanges and hTeamPpTimeRanges by joining adjacent ranges

	updatePage();
}

//
//
// Player information is stored in font elements
// This function parses the information stored in the font element and creates a player object to record stats
//
//

function initializePlayerData(fontElement, venue) {
	var jersey = parseInt(fontElement.innerHTML);
	var name = fontElement.title.substring(fontElement.title.indexOf(" - ") + 3).toLowerCase();
	var position = fontElement.title.substring(0, fontElement.title.indexOf(" - ")).toLowerCase();	
	var player = {
			jersey: jersey,
			name: name,
			position: position,
			ev_cf: 0,
			pp_cf: 0,
			sh_cf: 0,
			ev_ca: 0,
			pp_ca: 0,
			sh_ca: 0,
			ev_sf: 0,
			pp_sf: 0,
			sh_sf: 0,
			ev_sa: 0,
			pp_sa: 0,
			sh_sa: 0,
			ev_gf: 0,
			pp_gf: 0,
			sh_gf: 0,
			ev_ga: 0,
			pp_ga: 0,
			sh_ga: 0,
			ev_toi: 0,
			pp_toi: 0,
			sh_toi: 0,
			ev_ig: 0,
			pp_ig: 0,
			sh_ig: 0,
			ev_ic: 0,
			pp_ic: 0,
			sh_ic: 0,
			ev_ia: 0,
			pp_ia: 0,
			sh_ia: 0,
		};

	// Store player information
	var idx = 0;
	if (venue === "home") {
		idx = 1;
	}
	if (!playerData[idx].find(function(d) { return d.jersey === jersey; })) {
		playerData[idx].push(player);
	}

	return;
}

//
//
// Team information is stored in table elements
// This function parses the information stored in the table element and creates a team object to record stats
//
//

function initializeTeamInformation(tableElement, venue) {
	var teamString = tableElement.querySelector('td[style="font-size: 10px;font-weight:bold"]').innerHTML;
	var name = teamString.substring(0, teamString.indexOf("<br>")).toLowerCase();
	var abbreviation;
	if (name === "carolina hurricanes") { abbreviation = "car"; }
	else if (name === "columbus blue jackets") { abbreviation = "cbj"; }
	else if (name === "new jersey devils") { abbreviation = "njd"; }
	else if (name === "new york islanders") { abbreviation = "nyi"; }
	else if (name === "new york rangers") { abbreviation = "nyr"; }
	else if (name === "philadelphia flyers") { abbreviation = "phi"; }
	else if (name === "pittsburgh penguins") { abbreviation = "pit"; }
	else if (name === "washington capitals") { abbreviation = "wsh"; }
	else if (name === "boston bruins") { abbreviation = "bos"; }
	else if (name === "buffalo sabres") { abbreviation = "buf"; }
	else if (name === "detroit red wings") { abbreviation = "det"; }
	else if (name === "florida panthers") { abbreviation = "fla"; }
	else if (name === "montreal canadiens") { abbreviation = "mtl"; }
	else if (name === "ottawa senators") { abbreviation = "ott"; }
	else if (name === "tampa bay lightning") { abbreviation = "tbl"; }
	else if (name === "toronto maple leafs") { abbreviation = "tor"; }
	else if (name === "chicago blackhawks") { abbreviation = "chi"; }
	else if (name === "colorado avalanche") { abbreviation = "col"; }
	else if (name === "dallas stars") { abbreviation = "dal"; }
	else if (name === "minnesota wild") { abbreviation = "min"; }
	else if (name === "nashville predators") { abbreviation = "nsh"; }
	else if (name === "st. louis blues") { abbreviation = "stl"; }
	else if (name === "winnipeg jets") { abbreviation = "wpg"; }
	else if (name === "anaheim ducks") { abbreviation = "ana"; }
	else if (name === "arizona coyotes") { abbreviation = "ari"; }
	else if (name === "calgary flames") { abbreviation = "cgy"; }
	else if (name === "edmonton oilers") { abbreviation = "edm"; }
	else if (name === "los angeles kings") { abbreviation = "lak"; }
	else if (name === "san jose sharks") { abbreviation = "sjs"; }
	else if (name === "vancouver canucks") { abbreviation = "van"; }
	return {
		venue: venue,
		name: name,
		abbreviation: abbreviation,
		ev_cf: 0,
		pp_cf: 0,
		sh_cf: 0,
		ev_ca: 0,
		pp_ca: 0,
		sh_ca: 0,
		ev_sf: 0,
		pp_sf: 0,
		sh_sf: 0,
		ev_sa: 0,
		pp_sa: 0,
		sh_sa: 0,
		ev_gf: 0,
		pp_gf: 0,
		sh_gf: 0,
		ev_ga: 0,
		pp_ga: 0,
		sh_ga: 0,
		pp_toi: 0,
		sh_toi: 0
	}
}

//
//
// Get the team responsible for the event
//
//

function getEventTeam(event, description) {
	var team = null;
	if (event === "shot" || event === "miss" || event === "block" || event === "goal") {
		team = description.substring(0, description.indexOf(" "));
	}
	if (team) {
		team = team.toLowerCase();
	}
	// Use new team abbreviations
	if (team === "l.a") {
		team = "lak";
	} else if (name === "s.j") {
		team = "sjs";
	} else if (name === "t.b") {
		team = "tbl";
	} else if (name === "n.j") {
		team = "njd";
	}
	return team;
}


//
//
// Update page elements
//
//

function updatePage() {
	var tables = d3.selectAll("table.player-stats")
		.data(playerData);
	var rows = tables.select("tbody").selectAll("tr")
		.data(function(d) { return d; }, function(d) { return d.jersey; });
	rows = rows.enter().append("tr")
		.merge(rows);
	rows.exit().remove();

	// TODO
	// Append badges for goals and assists (G) (A)
	// Use dark fill with light text for even strength points
	// Use yellow fill with dark text special teams points
	// For data-previous, store and compare the total number of points
	
	var cells = rows.selectAll("td")
		.data(function(row) {
			return [
				{ column: "jersey", value: row.jersey },
				{ column: "name", value: row.name },
				{ column: "goals", value: row.ev_ig + row.pp_ig + row.sh_ig },
				{ column: "assists", value: row.ev_ia + row.pp_ia + row.sh_ia },
				{ column: "gf", value: row.ev_gf + row.pp_gf + row.sh_gf },
				{ column: "ga", value: row.ev_ga + row.pp_ga + row.sh_ga },
				{ column: "cf", value: row.ev_cf + row.pp_cf + row.sh_cf },
				{ column: "ca", value: row.ev_ca + row.pp_ca + row.sh_ca },
				{ column: "toi", value: row.ev_toi + row.pp_toi + row.sh_toi },
			];
		});
	cells = cells.enter().append("td")
		.style("background-color", "#fff")
		.merge(cells)
			.text(function(d) { return d.value; });
	cells.attr("data-previous", function(d) {
		// if (!d3.select(this).attr("data-previous")) {
		// 	console.log("what");
		// }
		if (String(d.value) !== d3.select(this).attr("data-previous")) {
			d3.select(this).transition()
				.style("background-color", "#fff3bf")
				.on("end", function() {
					d3.select(this).transition()
						.delay(100)
						.style("background-color", "#fff");
				});
		}
		return d.value;
	});
}
</script>
</html>